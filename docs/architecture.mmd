flowchart LR
    subgraph MainFlow["メインフロー"]
        direction TB
        EB[/"Amazon EventBridge\n毎日 0:00 JST"/]
        SF["AWS Step Functions\nMLOps Pipeline"]
        SM["Amazon SageMaker\nTraining Job\nml.g4dn.xlarge (GPU)"]
        LM["AWS Lambda\nAccuracy Checker\n精度評価"]
        DEPLOY{"モデルデプロイ\n精度 ≥ 85%?"}
        SUCCESS[/"デプロイ承認"/]
        NOTIFY["Amazon SNS\n精度未達通知"]
        
        EB -->|"トリガー"| SF
        SF -->|"1. 学習ジョブ起動"| SM
        SM -->|"学習完了"| SF
        SF -->|"2. 精度評価"| LM
        LM --> DEPLOY
        DEPLOY -->|"YES"| SUCCESS
        DEPLOY -->|"NO"| NOTIFY
    end

    subgraph CFN["AWS CloudFormation\n(Infrastructure as Code)"]
        direction TB
        
        subgraph IAM["AWS IAM Roles"]
            ROLE_SM["SageMaker\nExecution Role"]
            ROLE_SF["StepFunctions\nExecution Role"]
            ROLE_LM["Lambda\nExecution Role"]
            ROLE_EB["EventBridge\nExecution Role"]
        end
        
        subgraph S3Bucket["Amazon S3 Bucket"]
            S3_TRAIN[("training/\nデータセット")]
            S3_TEST[("testing/\nテストデータ")]
            S3_CODE[("code/\nソースコード")]
            S3_MODEL[("models/\nモデル成果物")]
            S3_LAMBDA[("lambda/\nLambdaコード")]
        end
        
        subgraph SNS_RES["Amazon SNS"]
            SNS_TOPIC["通知トピック"]
        end
    end

    %% Cross-subgraph connections
    SM -.->|"データ読込"| S3_TRAIN
    SM -.->|"コード読込"| S3_CODE
    SM -.->|"モデル保存"| S3_MODEL
    LM -.->|"モデル取得"| S3_MODEL
    NOTIFY -.-> SNS_TOPIC

    %% IAM connections
    ROLE_SM -.->|"権限"| SM
    ROLE_SF -.->|"権限"| SF
    ROLE_LM -.->|"権限"| LM
    ROLE_EB -.->|"権限"| EB

    %% Styling
    classDef eventbridge fill:#E7157B,stroke:#232F3E,color:white
    classDef stepfunctions fill:#E7157B,stroke:#232F3E,color:white
    classDef sagemaker fill:#01A88D,stroke:#232F3E,color:white
    classDef lambda fill:#ED7100,stroke:#232F3E,color:white
    classDef storage fill:#3F8624,stroke:#232F3E,color:white
    classDef iam fill:#DD344C,stroke:#232F3E,color:white
    classDef sns fill:#E7157B,stroke:#232F3E,color:white
    classDef decision fill:#FF9900,stroke:#232F3E,color:#232F3E
    classDef success fill:#1EC56D,stroke:#232F3E,color:white
    classDef cfn fill:#E7157B,stroke:#232F3E,color:white

    class EB eventbridge
    class SF stepfunctions
    class SM sagemaker
    class LM lambda
    class DEPLOY decision
    class SUCCESS success
    class NOTIFY sns
    class S3_TRAIN,S3_TEST,S3_CODE,S3_MODEL,S3_LAMBDA storage
    class ROLE_SM,ROLE_SF,ROLE_LM,ROLE_EB iam
    class SNS_TOPIC sns
